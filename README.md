# Codehub Ingest

![Build Status](https://codebuild.us-east-1.amazonaws.com/badges?uuid=eyJlbmNyeXB0ZWREYXRhIjoiRlVBSTZReThlVEpqcDNJMFg2NnBoYTU3VkxEZktpSFpDd1NnZ3Y3LzBlbnYyRHZSTW1DNDNOa0I5bWVJK1ZFQ1MvVTNLQk1jSXZNbHBwcTlEYTQ1Q0V3PSIsIml2UGFyYW1ldGVyU3BlYyI6IkdKdUdIMllGeXoyUjIzNjciLCJtYXRlcmlhbFNldFNlcmlhbCI6MX0%3D&branch=master)

**Table Of Contents**
* Prerequisites
* Usage
	* Building
	* Testing
	* Execution
* Additional Notes
* Version History and Retention
* License
* Contributions
* Contact Information
* Acknowledgements

# Project Description
Repository ingestion system used by ITS CodeHub to ingest repositories from Github, perform analysis, and store in ElasticSearch.

## Ingestion
Ingestion queries the `repositories` Elasticsearch index for a list of all repositories currently being tracked by CodeHub. Those repositories are queried from Github using their stored ETag to check if that repository has changed since last ingestion. If changes are detected (or the repository has never been ingested before), the repository will be ingested. 3 categories of information are stored for ingested repositories.
* Source data - Repository metadata returned by Github
* Generated data - Data generated by CodeHub for each repository. Currently, this includes Sonarqube metrics and virusscan results
* CodeHub data - This is data specific to the repository's record inside CodeHub

## SonarQube Scans
Each time a repository is ingested by CodeHub, the repository is cloned into the container, and a SonarQube scan is performed on the source code using [Sonar Runner](https://docs.sonarqube.org/display/SONARQUBE45/Analyzing+with+SonarQube+Runner). This requires a running Sonarqube instance address specified above.

## Virus Scanning
Each time a repository is ingested by CodeHub, the repository code is scanned using [ClamAV](https://www.clamav.net/), which is built as part of the Docker image.

# Prerequisites
- [Pip](https://pip.pypa.io/en/stable/) - Package Management
- [Docker](https://www.docker.com/) - Containerization
- [Sonarqube](https://www.sonarqube.org/) - Code Quality
- [Elasticsearch](https://www.elastic.co/) - Data Storage
- Github username and access token

# Usage

## Build
To build the docker image:
```
docker build . -t codehub-ingest
```
## Testing
//TODO

## Execution
To start the Docker container and begin the ingestion:
```
docker run --rm \
    --name codehub-ingest \
    -e GITHUB_USER=githubusername \
    -e GITHUB_ACCESS_TOKEN=ABCDEFGHIJ1234567890KLMNOPQRST1234567890 \
    -e SONAR_API_BASE_URL=https://localhost:9000 \
    -e ELASTICSEARCH_API_BASE_URL=https://localhost:9200 \
    -e ENVIRONMENT_NAME=local \
    -e SLACK_WEBHOOK_URL=https://hooks.slack.com/services/ABCDEFGHIJK/ABCDEFGHIJKLMNOPQRSTUVWXYZ \
    codehub-ingest
```

# Version History and Retention
**Release History: See [CHANGELOG.md](CHANGELOG.md)**

**Status:** This project is being actively developed.

**Retention:** This project will remain publicly accessible for a minimum of five years (until at least 07/01/2025).

# License
This project is licensed under the Creative Commons 1.0 Universal (CC0 1.0) License - see the [License.MD](https://github.com/usdot-jpo-codehub/codehub-readme-template/blob/master/LICENSE) for more details. 

# Contributions
Please read [CONTRIBUTING.md](https://github.com/usdot-jpo-codehub/codehub-readme-template/blob/master/Contributing.MD) for details on our Code of Conduct, the process for submitting pull requests to us, and how contributions will be released.

# Contact Information
Contact Name: ITS JPO
Contact Information: data.itsjpo@dot.gov, (888)-888-8888